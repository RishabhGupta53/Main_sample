$backend_pool = "bbu"
$backendPools = @{}

# Helper function to split and add with indexed key
function Add-BackendPoolEntry {
    param (
        [string]$prefix,
        [string]$value
    )

    if (![string]::IsNullOrEmpty($value)) {
        $items = $value -split ',' | ForEach-Object { $_.Trim() }
        for ($i = 0; $i -lt $items.Count; $i++) {
            $key = "{0}_{1:D3}" -f $prefix, ($i + 1)
            $backendPools[$key] = @($items[$i])
        }
    }
}

# Populate backendPools
Add-BackendPoolEntry "$backend_pool`_ip"         $appgateway.backend_ips
Add-BackendPoolEntry "$backend_pool`_fqdn"       $appgateway.backend_fqdns
Add-BackendPoolEntry "$backend_pool`_vm"         $appgateway.backend_vm_name
Add-BackendPoolEntry "$backend_pool`_appservice" $appgateway.app_service_name

# Add backend_pools to the appGateway object
$appgateway.backend_pools = $backendPools

# Final structure for input.tfvars
$finalObject = @{ appGateway = $appgateway }

# Convert to JSON and write to file
$finalJson = $finalObject | ConvertTo-Json -Depth 10
$finalJson | Out-File -FilePath ".\input.tfvars.json" -Encoding utf8
